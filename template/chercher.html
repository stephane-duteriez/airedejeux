{% extends "base.html" %}
{% import "macro.html" as macros %}
{% block head %}
    <title>Ou trouver des aire-de-jeux, recherche par ville</title>
    <meta name="description" content="Permet de rechercher les aire-de-jeux publics par ville, dans toute la France.
    Sur le principe des sites communautaires chaque'un peut y ajouter les places de jeux qu'il connaît déjà.">
{% endblock %}

{% block menu %}
    <li class="menu" onclick="location.href='/créerAireDeJeux'" style="cursor: pointer" id="bt_creation">Ajouter</li>
{% endblock %}

{% block content %}
<div id="cherche_ville">
    {{ macros.select_ville() }}
</div>
<div class="map_home" id="map_home" style="display:none">
    <div id="map"></div>
</div>
<div id="template-liste-aire-de-jeux" hidden>
    {% for i in range(5) %}
        <div class="blanc-aire-de-jeux"></div>
    {% endfor %}
</div>
<div id="list-aire-de-jeux">

</div>
<script>
    var map_ready = false;
    function hint(nom_ville) {
        var xmlhttp = new XMLHttpRequest();
        var data;
        var map = initialize(liste_ville[nom_ville].lat, liste_ville[nom_ville].lon);
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                var json = xmlhttp.responseText;
                data = JSON.parse(json);
                var out = "";
                if (data.length > 0){
                    var i;
                    template = "<div class=\"aire-de-jeux\" onclick=\"location.href='\aireDeJeux/%urlAireDeJeux%';\" style=\"cursor: pointer;\">" +
                        "<div class=\"nom-aire-de-jeux\">" + "%indice% " +
                        "%nom%</div></div>";
                    for(i = 0;i < data.length; i++) {
                        newAireDeJeux = template.replace("%nom%", data[i].nom);
                        newAireDeJeux = newAireDeJeux.replace("%urlAireDeJeux%", data[i].url);
                        newAireDeJeux = newAireDeJeux.replace("%indice%", (i+1).toString());
                        out += newAireDeJeux;
                        addMarker({ lat: data[i].lat, lng: data[i].lng}, map, i+1)
                    }
                } else {
                    out = "<div class=\"message\">Désolé mais il n'y a pas encore d'aire de jeux" +
                     "enregistré pour cette ville. Si vous en connaissez, vous pouvez les ajouter" +
                     "en cliquant le lien suivant</div>" +
                     "<p class=\"menu\" onclick=\"location.href='/créerAireDeJeux?keyVille=" + liste_ville[nom_ville].key  +
                     "'\" style=\"cursor: pointer\">Ajouter</p>";

                }
                document.getElementById("list-aire-de-jeux").innerHTML = out +
                                                        document.getElementById("template-liste-aire-de-jeux").innerHTML;
                document.getElementById("bt_creation").onclick = function() {
                     window.location.href= "/créerAireDeJeux?keyVille=" + liste_ville[nom_ville].key ;
                }
            }
        }
        xmlhttp.open("GET", "/listAireDeJeux?keyVille=" + liste_ville[nom_ville].key, true);
        xmlhttp.send();
        document.getElementById("hints").innerHTML = "";
    }
    function initialize(lat, lon) {
        document.getElementById("map_home").style.display= "block";
        var mapCanvas = document.getElementById("map");
        var myLatLng = {lat: lat, lng: lon};
        var styles =  [ { "stylers": [
            { "saturation": 5 },
            { "lightness": -5 },
            { "gamma": 1.16 },
            { "hue": "#004cff" } ]
        } ];
        var styledMap = new google.maps.StyledMapType(styles,
            {name: "Styled Map"});
        var mapOption = {
            center: myLatLng,
            zoom: 12,
            streetViewControl: false,
            mapTypeIds:[google.maps.MapTypeId.ROADMAP, 'map_style']
        }
        var map = new google.maps.Map(mapCanvas, mapOption);
        map.mapTypes.set('map_style', styledMap);
        map.setMapTypeId('map_style');
        if (screen.width<700) {
            map.setOptions({ scrollwheel: false });
            map.setOptions({ draggable: false });
        }
        return map;
    }
    function addMarker(location, map, i) {
        if (location.lat && location.lng) {
            var marker = new google.maps.Marker({
                position: location,
                map: map,
                label: i.toString()
            });
        }
    }
    function initMap() {
        map_ready = true;
    }

</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?callback=initMap">
</script>
{% endblock %}