{% extends "base.html" %}
{% import "macro.html" as macros %}
{% block head %}
    <script src="https://maps.googleapis.com/maps/api/js"></script>
{% endblock %}
{% block content %}
    <form action="/ajouterAireDeJeux" enctype="multipart/form-data" method="post">
        <input type="submit" value="Submit">
        <div class="contenant">
            <div class="contenue">
                <div hidden><input type="hidden" name="indice" value="{{ new_indice }}"></div>
                Nom de l'aire de jeux : <br>
                <div><input type="text" name="nom_aire_de_jeux" id="nom" value="" required></div>
                Commune : <br>
                <div><input type="text" name="commune" onkeyup="showHint(this.value)" id="ville_input" value=""></div>
                <div id="hints"></div>
                <div><input type="hidden" name="key_ville" id="key_ville" value="" required></div>
                CP : <br>
                <div><input type="text" name="CP" id="CP" value="" readonly></div>
                <div hidden>
                    latitude: <input type="hidden" name="lat" id="lat" readonly ><br>
                    longitude: <input type="hidden" name="lng" id="lng" readonly>
                </div>
                score : <br>
                <div id="stars">
                {% for i in range(5) %}
                    <svg width="22" height="22" class="stars" onclick="newScore({{ i }})">
                        <circle id="star_{{ i }}" cx="11" cy="11" r="10" stroke="green" stroke-width="1" fill="grey"/>
                    </svg>
                {% endfor %}
                </div>
                <div><input type="number" name="score" id="score" value=0 hidden></div>
                horaire :
                <div><input type="text" name="horaire"></div>
                tranche d'age:
                <div><input type="text" name="age"></div>
                 accéssibilité :
                <div><textarea name="acces" id="acces"></textarea></div>
                activités : Entrez une liste des activités séparées par une virgule<br>
                <div><textarea name="activites" class="box"></textarea></div>
                description : <br>
                <div><textarea name="description" class="box"></textarea></div>
                commentaire : <br>
                <div><textarea name="commentaire" class="box"></textarea></div>
            </div>
            <div class="contenue">
                <div id="map"></div>
                {{ macros.photos(listImage, new_indice) }}
            </div>
        </div>

        <input type="submit" value="Submit">
    </form>
    <script>
    function showHint(str) {
        if (str.length < 3) {
            document.getElementById("hints").innerHTML = "";
            return;
        } else {
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function() {
                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    json = xmlhttp.responseText;
                    data = JSON.parse(json);
                    var out = "";
                    var i;
                    template = "<button type=\"button\" id=\"%ID%\" onclick=\"hint('%nom%', '%CP%', '%key%', %lat%, %lon% )\" class=\"hint\">%nom% %CP%</button>"
                    for(i = 0; i < data["ville"].length; i++) {
                        new_button = template.replace(/%nom%/g, data["ville"][i].name);
                        new_button = new_button.replace(/%CP%/g, data["ville"][i].CP);
                        new_button = new_button.replace("%key%", data["ville"][i].key);
                        new_button = new_button.replace("%lat%", data["ville"][i].lat);
                        new_button = new_button.replace("%lon%", data["ville"][i].lon);
                        new_button = new_button.replace("%ID%", "hint_" + i.toString());
                        out += new_button;
                    }
                    document.getElementById("hints").innerHTML = out;
                }
            }
            xmlhttp.open("GET", "/listeVille?q=" + str, true);
            xmlhttp.send();
        }
    }

    function hint(nom_ville, CP, key_ville, lat, lon) {
        document.getElementById("ville_input").value = nom_ville;
        document.getElementById("CP").value = CP;
        document.getElementById("key_ville").value = key_ville;
        initialize(lat, lon);
        document.getElementById("hints").innerHTML = "";
    }

    function initialize(lat, lon) {
        var mapCanvas = document.getElementById("map");
        var myLatLng = {lat: lat, lng: lon};
        var styles =  [ { "stylers": [ { "saturation": 5 }, { "lightness": -5 },
        { "gamma": 1.16 }, { "hue": "#004cff" } ] } ];
        var styledMap = new google.maps.StyledMapType(styles,
    {name: "Styled Map"});
        var mapOption = {
            center: myLatLng,
            zoom: 12,
            mapTypeIds:[google.maps.MapTypeId.ROADMAP, 'map_style']
        }
        var map = new google.maps.Map(mapCanvas, mapOption);
        map.mapTypes.set('map_style', styledMap);
        map.setMapTypeId('map_style');
        var marker = new google.maps.Marker({
            position: myLatLng,
            map: map,
            title: 'Hello World!',
            draggable: true,
        });
        marker.addListener('dragend', function() {
            map.setCenter(marker.getPosition());
            document.getElementById("lat").value = marker.getPosition().lat();
            document.getElementById("lng").value = marker.getPosition().lng();
        });
        google.maps.event.addListener(map, 'dblclick', function(event) {
            placeMarker(marker, event.latLng);
        });
    }

    function placeMarker(marker, location) {
        marker.setPosition(location);
        document.getElementById("lat").value = marker.getPosition().lat();
        document.getElementById("lng").value = marker.getPosition().lng();
    }

    function newScore(score) {
        document.getElementById("score").value=score+1;
        for(i=0; i<5 ; i++ ){

            if(i<=score) {
                document.getElementById("star_" + i.toString()).setAttribute("fill","yellow");

            } else {
                document.getElementById("star_" + i.toString()).setAttribute("fill","grey");
            }
        }
    }

    {% if ville != "" %}
        hint("{{ville.nom}}", "{{ville.CP}}", "{{ville.urlsafeKey}}",{{ ville.coordonnees.lat}},{{ ville.coordonnees.lon}});
    {% endif %}


    </script>

{% endblock %}